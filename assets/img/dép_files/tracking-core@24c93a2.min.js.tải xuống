self.window.trackingSDK.define(["exports"],(function(e){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function n(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function u(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((o=o.apply(e,t||[])).next())}))}function o(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}var r,i=function(){function e(e,t){this.storage=e,this.storageKey=t}return e.prototype.get=function(){return this.storage.get(this.storageKey)||[]},e.prototype.set=function(e){return e=e||[],this.storage.set(this.storageKey,e)},e.prototype.enqueue=function(e){var t=this.get();t.push(e),this.set(t)},e.prototype.batchDequeue=function(e){var t=this.get(),n=t.slice(0,e),o=t.slice(e);return this.set(o),n},e.prototype.putBackBatchToQueue=function(e){return this.set(e.concat(this.get()))},e}(),s=function(){function e(){var t=this;this.backStore={},this.storage={get:function(e){return t.backStore[e]},set:function(e,n){return t.backStore[e]=n,!0}},this.queue=new i(this.storage,e.QUEUE_STORAGE_KEY)}return e.prototype.init=function(){return n(this,void 0,void 0,(function(){return o(this,(function(e){return[2,void 0]}))}))},e.prototype.addEvent=function(e){return this.queue.enqueue(e),Promise.resolve()},e.prototype.getEvents=function(e){var t=-1===e?this.queue.get():this.queue.batchDequeue(e);return Promise.resolve({data:t})},e.prototype.resetEvents=function(e,t){return this.queue.putBackBatchToQueue(t),Promise.resolve()},e.prototype.removeEvents=function(e){return Promise.resolve()},e.prototype.getSession=function(n,o){var r=this.storage.get(e.SESSION_STORAGE_KEY),i=t({},null==r?void 0:r.sequenceIds),s=isNaN(i[n])?0:i[n];return r=o(r=r&&"sessionId"in r&&"number"==typeof s&&"timestamp"in r?{sequenceId:s,timestamp:r.timestamp,sessionId:r.sessionId,sequenceIds:{}}:void 0),this.storage.set(e.SESSION_STORAGE_KEY,{sessionId:r.sessionId,timestamp:r.timestamp,sequenceIds:r.sequenceIds}),Promise.resolve(r)},e.prototype.getCurrentSessionId=function(){var t=this.storage.get(e.SESSION_STORAGE_KEY),n=t&&"sessionId"in t?t.sessionId:void 0;return Promise.resolve(n)},e.prototype.removeExpiredEvents=function(){return Promise.resolve()},e.QUEUE_STORAGE_KEY="bi-tracking::events",e.SESSION_STORAGE_KEY="bi-tracking::session",e.CHECK_STORAGE_KEY="bi-tracking::check",e}(),u=function(){function e(e){void 0===e&&(e=4),this.DATABASE_VERSION=4,this.DATABASE_VERSION=e}return e.prototype.init=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,this.openDB(e.DATABASE_NAME,this.DATABASE_VERSION)];case 1:return t=n.sent(),this.idb=t,[2]}}))}))},e.prototype.upgrade=function(t,n){if(n.oldVersion<this.DATABASE_VERSION&&(t.objectStoreNames.contains(e.OBJECT_STORE_EVENTS)&&t.deleteObjectStore(e.OBJECT_STORE_EVENTS),t.objectStoreNames.contains(e.OBJECT_STORE_EVENTS_V1)&&t.deleteObjectStore(e.OBJECT_STORE_EVENTS_V1),t.objectStoreNames.contains(e.OBJECT_STORE_SESSIONS_V1)&&t.deleteObjectStore(e.OBJECT_STORE_SESSIONS_V1)),!t.objectStoreNames.contains(e.OBJECT_STORE_EVENTS)){var o=t.createObjectStore(e.OBJECT_STORE_EVENTS,{autoIncrement:!0});o.createIndex(e.INDEX_EVENTS_FETCHED,e.INDEX_EVENTS_FETCHED,{unique:!1}),o.createIndex(e.INDEX_EVENT_TIMESTAMP,e.INDEX_EVENT_TIMESTAMP,{unique:!1})}t.objectStoreNames.contains(e.OBJECT_STORE_SESSIONS)||t.createObjectStore(e.OBJECT_STORE_SESSIONS)},e.prototype.openDB=function(t,n){var o=this;return new Promise((function(r,i){var s=self.window.indexedDB.open(t,n);s.onblocked=function(){console.warn("[IndexedDBStorage] Upgrade is blocked since connection to old version exists.")},s.onerror=function(e){try{e.preventDefault()}catch(e){}i(e)},s.onsuccess=function(){var t=s.result;t.objectStoreNames.contains(e.OBJECT_STORE_EVENTS)&&t.objectStoreNames.contains(e.OBJECT_STORE_SESSIONS)?(t.onerror=function(e){console.warn("[IndexedDBStorage]",e.errorCode)},t.onversionchange=function(){t.close(),console.warn("[IndexedDBStorage] A new version of indexedDB is ready.")},r(t)):i("Required ObjectStore cannot be found.")},s.onupgradeneeded=function(e){var t=s.result;try{o.upgrade(t,e)}catch(e){i(e)}}}))},e.prototype.addEvent=function(t){var n=this;return new Promise((function(o,r){var i=n.idb.transaction(e.OBJECT_STORE_EVENTS,"readwrite");i.oncomplete=function(){o()},i.onerror=function(e){r(e)},i.onabort=function(e){r(e)},i.objectStore(e.OBJECT_STORE_EVENTS).add({data:JSON.stringify(t),timestamp:Date.now(),fetched:"f"})}))},e.prototype.getEvents=function(n){var o=this,r=[],i=[];return new Promise((function(s,u){var a=o.idb.transaction(e.OBJECT_STORE_EVENTS,"readwrite");a.oncomplete=function(){s({keys:r,data:i})},a.onerror=function(e){u(e)},a.onabort=function(e){u(e)};var c=IDBKeyRange.only("f"),f=a.objectStore(e.OBJECT_STORE_EVENTS).index(e.INDEX_EVENTS_FETCHED).openCursor(c);f.onsuccess=function(){var e=f.result;e&&(r.push(e.primaryKey),i.push(JSON.parse(e.value.data)),e.update(t(t({},e.value),{fetched:"t"})),(-1===n||n-- >1)&&e.continue())}}))},e.prototype.resetEvents=function(n){var o=this;return!n||n.length<=0?Promise.resolve():new Promise((function(r,i){var s=o.idb.transaction(e.OBJECT_STORE_EVENTS,"readwrite");s.oncomplete=function(){r()},s.onerror=function(e){i(e)},s.onabort=function(e){i(e)};var u=IDBKeyRange.bound(n[0],n[n.length-1]),a=s.objectStore(e.OBJECT_STORE_EVENTS).openCursor(u);a.onsuccess=function(){var e=a.result;e&&(e.update(t(t({},e.value),{fetched:"f"})),e.continue())}}))},e.prototype.removeEvents=function(t){var n=this;return!t||t.length<=0?Promise.resolve():new Promise((function(o,r){var i=n.idb.transaction(e.OBJECT_STORE_EVENTS,"readwrite");i.oncomplete=function(){o()},i.onerror=function(e){r(e)},i.onabort=function(e){r(e)};var s=IDBKeyRange.bound(t[0],t[t.length-1]);i.objectStore(e.OBJECT_STORE_EVENTS).delete(s)}))},e.prototype.getSession=function(n,o){var r=this;return new Promise((function(i,s){var u,a=r.idb.transaction(e.OBJECT_STORE_SESSIONS,"readwrite");a.oncomplete=function(){i(u)},a.onerror=function(e){s(e)},a.onabort=function(e){s(e)};var c=a.objectStore(e.OBJECT_STORE_SESSIONS);new Promise((function(t,n){var o=c.get(e.KEY_SESSION);o.onsuccess=function(){return t(o.result)},o.onerror=function(){return n()}})).then((function(r){var i,s;if(r){s=t({},r.sequenceIds);var a=isNaN(s[n])?0:s[n];u=o(t(t({},r),{sequenceIds:s,sequenceId:a}))}else u=o();c.put({sessionId:u.sessionId,timestamp:u.timestamp,sequenceIds:t(t({},s),(i={},i[n]=u.sequenceId,i))},e.KEY_SESSION)}))}))},e.prototype.getCurrentSessionId=function(){var t=this;return new Promise((function(n,o){var r,i=t.idb.transaction(e.OBJECT_STORE_SESSIONS,"readwrite");i.oncomplete=function(){n(null==r?void 0:r.sessionId)},i.onerror=function(e){o(e)},i.onabort=function(e){o(e)};var s=i.objectStore(e.OBJECT_STORE_SESSIONS).get(e.KEY_SESSION);s.onsuccess=function(){r=s.result}}))},e.prototype.removeExpiredEvents=function(){var t=this;return new Promise((function(n,o){var r=t.idb.transaction(e.OBJECT_STORE_EVENTS,"readwrite");r.oncomplete=function(){n()},r.onerror=function(e){o(e)},r.onabort=function(e){o(e)};var i=IDBKeyRange.upperBound(Date.now()-e.RETENTION),s=r.objectStore(e.OBJECT_STORE_EVENTS).index(e.INDEX_EVENT_TIMESTAMP).openCursor(i);s.onsuccess=function(){var e=s.result;e&&(e.delete(),e.continue())}}))},e.DATABASE_NAME="data-tracking",e.OBJECT_STORE_EVENTS_V1="events",e.OBJECT_STORE_EVENTS="events_v2",e.OBJECT_STORE_SESSIONS_V1="sessions",e.OBJECT_STORE_SESSIONS="session_v2",e.INDEX_EVENTS_FETCHED="fetched",e.INDEX_EVENT_TIMESTAMP="timestamp",e.KEY_SESSION="current_session",e.RETENTION=1728e5,e}(),a=new Uint8Array(16);function c(){if(!r&&!(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(a)}var f=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function p(e){return"string"==typeof e&&f.test(e)}for(var d=[],l=0;l<256;++l)d.push((l+256).toString(16).substr(1));function S(e,t,n){var o=(e=e||{}).random||(e.rng||c)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(var r=0;r<16;++r)t[n+r]=o[r];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+"-"+d[e[t+4]]+d[e[t+5]]+"-"+d[e[t+6]]+d[e[t+7]]+"-"+d[e[t+8]]+d[e[t+9]]+"-"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]).toLowerCase();if(!p(n))throw TypeError("Stringified UUID is invalid");return n}(o)}var E="",h="",v=new(function(){function e(){}return e.prototype.useStorage=function(e){this.trackerStorage?e instanceof u&&this.trackerStorage instanceof s?this.trackerStorage=e:console.warn("There is already an IndexedDBStorage / memostorage in session manager, can not update storage."):this.trackerStorage=e},e.prototype.getSession=function(t){var r=t.flag,i=t.reset,s=void 0!==i&&i,u=t.lastSessionId;return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.trackerStorage.getSession(r,(function(t){var n=Date.now();return!0===s||null==t||n-t.timestamp>e.SESSION_DURATION?t={sessionId:S(),timestamp:n,sequenceId:0,sequenceIds:{}}:u&&u!==t.sessionId?(t.sequenceId=0,t.timestamp=n):(t.sequenceId+=1,t.timestamp=n),t}))];case 1:return[2,t.sent()]}}))}))},e.prototype.GetSessionId=function(e){var t=e.flag,r=e.reset,i=void 0!==r&&r,s=e.lastSessionId;return n(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,this.trackerStorage.getCurrentSessionId()];case 1:return(e=n.sent())?[2,e]:[4,this.getSession({flag:t,reset:i,lastSessionId:s})];case 2:return[2,n.sent().sessionId]}}))}))},e.prototype.setLatestEventId=function(e){E=e},e.prototype.getLatestEventId=function(){return E},e.prototype.setLatestViewPageType=function(e){h=e},e.prototype.getLatestViewPageType=function(){return h},e.SESSION_DURATION=18e5,e}()),y="object"==typeof self?self:"object"==typeof window?window:"object"==typeof top&&top||{},O=y.document||{},b=y.location||{},g=y.navigator||{};var T=t(t({},{test:"test.",stable:"test-stable.",staging:"staging.",liveish:"live-test.",live:"",sandbox:"sandbox.",uat:"uat."}),{liveish:""});var m="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},_={exports:{}};!function(e,t){!function(n,o){var r={};n.PubSub?(r=n.PubSub,console.warn("PubSub already loaded, using existing version")):(n.PubSub=r,function(e){var t={},n=-1,o="*";function r(e){var t;for(t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!0;return!1}function i(e){return function(){throw e}}function s(e,t,n){try{e(t,n)}catch(e){setTimeout(i(e),0)}}function u(e,t,n){e(t,n)}function a(e,n,o,r){var i,a=t[n],c=r?u:s;if(Object.prototype.hasOwnProperty.call(t,n))for(i in a)Object.prototype.hasOwnProperty.call(a,i)&&c(a[i],e,o)}function c(e,t,n){return function(){var r=String(e),i=r.lastIndexOf(".");for(a(e,e,t,n);-1!==i;)i=(r=r.substr(0,i)).lastIndexOf("."),a(e,r,t,n);a(e,o,t,n)}}function f(e){var n=String(e);return Boolean(Object.prototype.hasOwnProperty.call(t,n)&&r(t[n]))}function p(e){for(var t=String(e),n=f(t)||f(o),r=t.lastIndexOf(".");!n&&-1!==r;)r=(t=t.substr(0,r)).lastIndexOf("."),n=f(t);return n}function d(e,t,n,o){var r=c(e="symbol"==typeof e?e.toString():e,t,o);return!!p(e)&&(!0===n?r():setTimeout(r,0),!0)}e.publish=function(t,n){return d(t,n,!1,e.immediateExceptions)},e.publishSync=function(t,n){return d(t,n,!0,e.immediateExceptions)},e.subscribe=function(e,o){if("function"!=typeof o)return!1;e="symbol"==typeof e?e.toString():e,Object.prototype.hasOwnProperty.call(t,e)||(t[e]={});var r="uid_"+String(++n);return t[e][r]=o,r},e.subscribeAll=function(t){return e.subscribe(o,t)},e.subscribeOnce=function(t,n){var o=e.subscribe(t,(function(){e.unsubscribe(o),n.apply(this,arguments)}));return e},e.clearAllSubscriptions=function(){t={}},e.clearSubscriptions=function(e){var n;for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&0===n.indexOf(e)&&delete t[n]},e.countSubscriptions=function(e){var n,o,r=0;for(n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&0===n.indexOf(e)){for(o in t[n])r++;break}return r},e.getSubscriptions=function(e){var n,o=[];for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&0===n.indexOf(e)&&o.push(n);return o},e.unsubscribe=function(n){var o,r,i,s=function(e){var n;for(n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&0===n.indexOf(e))return!0;return!1},u="string"==typeof n&&(Object.prototype.hasOwnProperty.call(t,n)||s(n)),a=!u&&"string"==typeof n,c="function"==typeof n,f=!1;if(!u){for(o in t)if(Object.prototype.hasOwnProperty.call(t,o)){if(r=t[o],a&&r[n]){delete r[n],f=n;break}if(c)for(i in r)Object.prototype.hasOwnProperty.call(r,i)&&r[i]===n&&(delete r[i],f=!0)}return f}e.clearSubscriptions(n)}}(r)),void 0!==e&&e.exports&&(t=e.exports=r),t.PubSub=r,e.exports=t=r}("object"==typeof window&&window||m)}(_,_.exports);var I=_.exports;function w(e){"undefined"!=typeof requestIdleCallback?requestIdleCallback((function(){return e()}),{timeout:500}):e()}function N(e){return new Promise((function(t){setTimeout((function(){t()}),e)}))}var B="undefined"!=typeof Blob?function(e){return new Blob([e]).size}:function(e){return e.length};function C(e,t,n){void 0===n&&(n="POST");var o=Object.assign({"Content-Type":"application/json"},null==t?void 0:t.headers);return"undefined"!=typeof fetch?fetch(e,{method:n,headers:o,body:t.body}):new Promise((function(r,i){var s=new XMLHttpRequest;s.open(n,e),Object.keys(o).forEach((function(e){s.setRequestHeader(e,o[e])})),s.onload=function(){r(s.response)},s.onerror=function(){i(s.response)},s.send(t.body)}))}var R=function(){function e(e){this.INTERVAL_PERIOD=1e4,this.enable=!0,Object.assign(this,e),this.intervalCallee(),this.unloadCallee()}return e.prototype.onInterval=function(){return Promise.resolve()},e.prototype.onFinish=function(){return Promise.resolve()},e.prototype.onError=function(e){return Promise.resolve()},e.prototype.onUnload=function(){},e.prototype.unloadCallee=function(){var e=this;document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&e.onUnload()})),window.addEventListener("pagehide",(function(){e.onUnload()}),!1),window.onbeforeunload=function(){e.onUnload()}},e.prototype.intervalCallee=function(){var e=this;this.enable&&this.onInterval().then(this.onFinish).catch(this.onError).then((function(){return N(e.INTERVAL_PERIOD)})).then((function(){return e.intervalCallee()}))},e.prototype.trigger=function(e){this.enable=e},e}(),P="debugview",x=function(){function e(e){this.options=e}return e.prototype.init=function(e){throw"no implement"},e.prototype.logDirectly=function(e){throw"no implement"},e.prototype.logBatchly=function(e){throw"no implement"},e.prototype.logJSBridge=function(e){throw"no implement"},e.prototype.preProcess=function(e){throw"no implement"},e.prototype.initScheduler=function(){throw"no implement"},e.prototype.logEvent=function(e){var t=this;w((function(){t.realLogEvent(e)}))},e.prototype.logEventWithoutSchedule=function(e){return this.realLogEvent(e)},e.prototype.realLogEvent=function(e){var t=this;return this.preProcess(e).then((function(e){return I.publish(P,e),t.options.sendImmediately?t.logDirectly(e):t.logBatchly(e)}))},e}(),V=new Map;e.DEBUG_VIEW_TOPIC=P,e.ITracker=x,e.IndexedDBStorage=u,e.MemoStorage=s,e.PubSub=I,e.Scheduler=R,e.byteSize=B,e.constraintSize=function(e,t,n){void 0===n&&(n=1e6);var o=[e],r=function(e){try{return B(JSON.stringify(e))}catch(e){return 0}}(e),i=Math.ceil(r/n);if(i<2)return o;for(;o.length<i;){var s=o.reduce((function(e,n){var o=t(n);return e.push.apply(e,o),e}),[]);if(!(s.length>o.length))break;o=s}return o},e.detectBrowser=function(){return void 0===g?"unknown":-1!==g.userAgent.indexOf("Chrome")?"Chrome":-1!==g.userAgent.indexOf("Firefox")?"Firefox":-1!==g.userAgent.indexOf("MSIE")?"Internet Exploder":-1!==g.userAgent.indexOf("Edge")?"Edge":-1!==g.userAgent.indexOf("Safari")?"Safari":-1!==g.userAgent.indexOf("Opera")?"Opera":"Others"},e.detectConnection=function(){if(void 0===g)return"unknown";var e=g.connection||g.mozConnection||g.webkitConnection;return e&&e.effectiveType||"unknown"},e.detectOS=function(){var e="Unknown OS";return-1!=g.appVersion.indexOf("Win")&&(e="Windows"),-1!=g.appVersion.indexOf("Mac")&&(e="MacOS"),-1!=g.appVersion.indexOf("X11")&&(e="UNIX"),-1!=g.appVersion.indexOf("Linux")&&(e="Linux"),e},e.document=O,e.getCookie=function(e){if("undefined"!=typeof document){var t=("; "+document.cookie).split("; "+e+"=");return 2===t.length?t.pop().split(";").shift():void 0}},e.getDEDeviceID=function(){var e="de_device_id",t="";try{(t=localStorage.getItem(e))||(t=S(),localStorage.setItem(e,t))}catch(e){console.warn(e,"gerenate by uuid"),t=S()}return t},e.getEndpoint=function(e,t,n){return"apms"===n?"https://patronus."+T[e]+"idata.shopeemobile.com/event-receiver/api/v4/"+t:"https://c-api-bit."+T[e]+"shopeemobile.com/"+t+"/"+n},e.location=b,e.navigator=g,e.pick=function(e,t){var n={};return t.forEach((function(t){n[t]=e[t]})),n},e.request=C,e.runningInstance=V,e.scheduleWhenIdle=w,e.sendBeacon=function(e,t){"undefined"!=typeof navigator&&navigator.sendBeacon?navigator.sendBeacon(e,t):C(e,{headers:{"Content-Type":"application/json"},body:t})},e.sleep=N,e.trackingSessionManager=v,e.uuidv4=S,e.withRetry=function e(t,n,o){return void 0===n&&(n=1e3),t().catch((function(r){return console.warn(r),"number"==typeof o&&o--,o>0||"INF"===o?N(Math.min(n,2e4)).then((function(){return e(t,2*n,o)})):Promise.reject(r)}))},Object.defineProperty(e,"__esModule",{value:!0})}));